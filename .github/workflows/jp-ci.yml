
name: JP CI (Verify + Doctor)

on:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]
  schedule:
    # Weekly scan â€” Sundays at 03:00 UTC
    - cron: "0 3 * * 0"
  workflow_dispatch: {}

permissions:
  contents: read

jobs:
  verify_doctor:
    name: Verify + Doctor (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    env:
      SEMGREP_VERSION: "1.151.0"

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install JP toolchain (CI)
        shell: pwsh
        run: |
          # Ensure Chocolatey is ready (windows-latest includes it)
          choco --version

          # OpenSSL + Gitleaks (jp-verify requires openssl; doctor uses gitleaks if present)
          choco install openssl.light -y --no-progress
          choco install gitleaks -y --no-progress

          # Node CLIs jp-verify expects
          npm install -g vercel netlify-cli

          # Python tools jp-verify expects
          python -m pip install --upgrade pip
          python -m pip install pipx
          pipx --version
          pipx install pre-commit
          pre-commit --version

          # Print versions for logs (best-effort; don't fail CI if gh is missing)
          git --version
          if (Get-Command gh -ErrorAction SilentlyContinue) { gh --version } else { Write-Host "gh not found (ok)" }
          openssl version
          node --version
          npm --version
          vercel --version
          netlify --version
          gitleaks version

      - name: Install semgrep (pinned)
        shell: pwsh
        run: |
          python -m pip install "semgrep==${env:SEMGREP_VERSION}"
          semgrep --version

      - name: Map workspace to expected JP path
        shell: pwsh
        run: |
          # jp-doctor/jp-verify may assume this local dev path exists.
          # On GitHub runners, the repo lives under $env:GITHUB_WORKSPACE (e.g., D:\a\jp-engine\jp-engine).
          # Create a junction so scripts that expect C:\Dev\JP_ENGINE\jp-engine can still run in CI.
          $expected = "C:\Dev\JP_ENGINE\jp-engine"
          $parent   = Split-Path $expected -Parent

          New-Item -ItemType Directory -Force -Path $parent | Out-Null

          if (Test-Path $expected) {
            try {
              Remove-Item -LiteralPath $expected -Force -Recurse
            } catch {
              # If removal fails, continue and attempt to overwrite with a new junction
            }
          }

          New-Item -ItemType Junction -Path $expected -Target $env:GITHUB_WORKSPACE | Out-Null

          Write-Host "Mapped $expected -> $env:GITHUB_WORKSPACE"
          Get-Item -LiteralPath $expected | Format-List

      - name: Run jp-verify
        shell: pwsh
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File .\scripts\jp-verify.ps1

      - name: Run jp-doctor
        shell: pwsh
        run: |
          pwsh -NoProfile -ExecutionPolicy Bypass -File .\scripts\jp-doctor.ps1
